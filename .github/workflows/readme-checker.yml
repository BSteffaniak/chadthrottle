name: README Accuracy Checker

on:
  schedule:
    - cron: "0 8 * * 1" # Weekly on Monday at 8am UTC
  workflow_dispatch:
    inputs:
      packages:
        description: "Specific packages (comma-separated, empty for all)"
        required: false
        type: string

      prompt_override:
        description: "Additional guidance"
        required: false
        type: string

permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  create-branch:
    name: Create update branch
    runs-on: ubuntu-latest
    outputs:
      branch-name: ${{ steps.branch.outputs.branch_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.CHADTHROTTLE_TOKEN }}
          fetch-depth: 0

      - name: Create branch
        id: branch
        uses: MoosicBox/MoosicBox/.github/actions/claude-checker@master
        with:
          command: create-branch
          github_token: ${{ secrets.CHADTHROTTLE_TOKEN }}
          branch_prefix: readme-updates

  determine-packages:
    name: Determine packages to update
    runs-on: ubuntu-latest
    needs: [create-branch]
    outputs:
      matrix: ${{ steps.analyze.outputs.matrix }}
      has-packages: ${{ steps.analyze.outputs.has-changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.CHADTHROTTLE_TOKEN }}
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable

      - name: Generate package matrix
        id: analyze
        uses: MoosicBox/MoosicBox/.github/actions/clippier@master
        with:
          command: packages
          packages: ${{ github.event.inputs.packages }}
          skip-on-no-changes: "false"
          force-full-matrix-condition: "true"
          os-suffix: "-latest"
          os: "ubuntu"
          clippier-version: "master"

  update-package-readmes:
    name: Update ${{ matrix.package.name }} README
    runs-on: ubuntu-latest
    needs: [create-branch, determine-packages]
    if: needs.determine-packages.outputs.has-packages == 'true'
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.determine-packages.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.CHADTHROTTLE_TOKEN }}
          ref: ${{ needs.create-branch.outputs.branch-name }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update or create README with Claude
        uses: MoosicBox/MoosicBox/.github/actions/claude-checker@master
        with:
          command: check
          github_token: ${{ secrets.CHADTHROTTLE_TOKEN }}
          claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_template: "readme"
          claude_args: --allowedTools Edit,Read,Write

          template_vars: |
            project_name: ChadThrottle
            package_name: ${{ matrix.package.name }}
            package_path: ${{ matrix.package.path }}
            is_workspace_package: true

          branch_name: ${{ needs.create-branch.outputs.branch-name }}
          auto_commit: true
          enable_resilient_push: true
          push_max_retries: 5

      - name: Format with prettier
        if: always()
        run: |
          README_PATH="${{ matrix.package.path }}/README.md"
          if [ -f "$README_PATH" ]; then
            npx -y prettier --write "$README_PATH"
            
            if [ -n "$(git status --porcelain)" ]; then
              git add "$README_PATH"
              git commit --amend --no-edit
              git push --force-with-lease origin ${{ needs.create-branch.outputs.branch-name }}
            fi
          fi

  update-root-readme:
    name: Update root README
    runs-on: ubuntu-latest
    needs: [create-branch]
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.CHADTHROTTLE_TOKEN }}
          ref: ${{ needs.create-branch.outputs.branch-name }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update root README with Claude
        uses: MoosicBox/MoosicBox/.github/actions/claude-checker@master
        with:
          command: check
          github_token: ${{ secrets.CHADTHROTTLE_TOKEN }}
          claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_template: "readme"
          claude_args: --allowedTools Edit,Read,Write

          template_vars: |
            project_name: ChadThrottle
            readme_path: README.md
            is_root: true

          branch_name: ${{ needs.create-branch.outputs.branch-name }}
          auto_commit: true
          enable_resilient_push: true

      - name: Format with prettier
        if: always()
        run: |
          if [ -f "README.md" ]; then
            npx -y prettier --write "README.md"
            
            if [ -n "$(git status --porcelain)" ]; then
              git add README.md
              git commit --amend --no-edit
              git push --force-with-lease origin ${{ needs.create-branch.outputs.branch-name }}
            fi
          fi

  create-pr:
    name: Create Pull Request
    runs-on: ubuntu-latest
    needs: [create-branch, update-package-readmes, update-root-readme]
    if: always() && needs.create-branch.result == 'success'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.CHADTHROTTLE_TOKEN }}
          ref: ${{ needs.create-branch.outputs.branch-name }}
          fetch-depth: 0

      - name: Create PR
        uses: MoosicBox/MoosicBox/.github/actions/claude-checker@master
        with:
          command: create-pr
          github_token: ${{ secrets.CHADTHROTTLE_TOKEN }}
          branch_name: ${{ needs.create-branch.outputs.branch-name }}
          pr_base_branch: master
          pr_title: "üìù Automated README Updates"
          pr_body: |
            ## ü§ñ Automated README Accuracy Review

            Updates to ensure all README files accurately reflect ChadThrottle's current state.

            ### üìã What was reviewed:
            - ‚úÖ Root README.md
            - ‚úÖ All package READMEs

            **Branch:** `${branch_name}`
            **Run:** ${run_url}
          pr_labels: "automated,documentation"
